<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrplan</title>
    <meta name="author" content="Anton P. Braun and Felix Divo">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <noscript>JavaScript is required to render the schedule. Please enable it and reload.</noscript>
    <div class="schedule-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">27.12.2025 – 30.12.2025</div>
            <div class="header-right"><span class="c3-logo">&lt;&lt;39C3</span></div>
        </div>

        <!-- Title Section -->
        <div class="title-section">
            <div class="title-label">
                <span class="title-label-bold">Abfahrt</span>
                <span class="title-label-italic">Departure</span>
                <span class="title-label-italic">Départ</span>
            </div>
            <div class="station-name">Chaos Communication Congress</div>
        </div>

        <!-- Column Headers - Repeated 8 times -->
        <div class="column-headers-wrapper">
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
            <div class="column-headers">
                <div>
                    <div class="column-header-bold">Zeit</div>
                    <div class="column-header-italic">Time</div>
                </div>
                <div>
                    <div class="column-header-bold">Zug</div>
                    <div class="column-header-italic">Train</div>
                </div>
                <div>
                    <div class="column-header-bold">Richtung</div>
                    <div class="column-header-italic">Destination</div>
                </div>
                <div class="col-platform">
                    <div class="column-header-bold">Gleis</div>
                    <div class="column-header-italic">Platform</div>
                </div>
            </div>
        </div>

        <!-- Departure Rows -->
        <div class="departure-table"></div>
    </div>

        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
        <script>
            (async () => {
                // Event-specific configuration
                const scheduleUrl = 'https://api.events.ccc.de/congress/2025/schedule.json';
                const trackMap = {
                    'Art & Beauty': 'ART',
                    'CCC & Community': 'CCC',
                    'Entertainment': 'FUN',
                    'Ethics, Society & Politics': 'ESP',
                    'Hardware': 'HARD',
                    'Science': 'SCI',
                    'Security': 'SEC',
                    'DJ-Set': 'DJ',
                    'Live Performance': 'LP',
                    null: 'NAT',
                    undefined: 'NAT',
                };
                const totalDays = 4;
                const headerDateRange = '27.12.2025 – 30.12.2025';
                const stationName = 'Chaos Communication Congress';
                const timeRanges = [
                    { start: 9, end: 11, label: '9.00 — 11.00' },
                    { start: 12, end: 13, label: '12.00 — 13.00' },
                    { start: 14, end: 15, label: '14.00 — 15.00' },
                    { start: 16, end: 18, label: '16.00 — 18.00' },
                    { start: 19, end: 20, label: '19.00 — 20.00' },
                    { start: 21, end: 22, label: '21.00 — 22.00' },
                    { start: 23, end: 1, label: '23.00 — 01.00' },
                    { start: 2, end: 4, label: '02.00 — 04.00' },
                    { start: 5, end: 8, label: '05.00 — 08.00' },
                ];

                // URL parameter parsing
                const params = new URLSearchParams(location.search);
                const onlyDayParam = params.get('only-day');
                const onlyTrackParam = params.get('only-track');
                const onlyRoomParam = params.get('only-room');
                const isSingleDay = onlyDayParam !== null;
                const selectedDay = parseInt(onlyDayParam ?? '1', 10);

                // DOM hooks
                const headerLeft = document.querySelector('.header-left');
                const stationNameEl = document.querySelector('.station-name');
                const departureTable = document.querySelector('.departure-table');
                if (!departureTable) return;

                // Apply header labels
                if (headerLeft && headerDateRange) headerLeft.textContent = headerDateRange;
                if (stationNameEl && stationName) stationNameEl.textContent = stationName;

                // Build active filter label text
                const filterLabelParts = [];
                if (onlyRoomParam) filterLabelParts.push(onlyRoomParam);
                const trackDisplay = (() => {
                    if (!onlyTrackParam) return null;
                    const target = onlyTrackParam.toLowerCase();
                    const matchFull = Object.keys(trackMap).find((name) => (name || '').toLowerCase() === target);
                    if (matchFull) return matchFull;
                    const matchCode = Object.entries(trackMap).find(([, code]) => (code || '').toLowerCase() === target);
                    if (matchCode) return matchCode[0];
                    return onlyTrackParam;
                })();
                if (trackDisplay) filterLabelParts.push(trackDisplay);
                if (stationNameEl && filterLabelParts.length) {
                    stationNameEl.textContent = `${stationName} — ${filterLabelParts.join(' — ')}`;
                }

                // Filter predicate
                const passesFilters = (talk, roomName) => {
                    if (onlyTrackParam) {
                        const target = onlyTrackParam.toLowerCase();
                        const trackRaw = (talk.track || '').toString().toLowerCase();
                        const trackCode = (trackMap[talk.track] || '').toLowerCase();
                        if (trackRaw !== target && trackCode !== target) return false;
                    }
                    if (onlyRoomParam) {
                        const targetRoom = onlyRoomParam.toLowerCase();
                        const roomLower = roomName.toLowerCase();
                        if (roomLower !== targetRoom && !roomLower.includes(targetRoom)) return false;
                    }
                    return true;
                };

                const showError = (msg) => {
                    departureTable.innerHTML = `<div class="no-data">${msg}</div>`;
                };
                departureTable.innerHTML = '<div class="loading">Lade Inhalte…</div>';

                // Fetch schedule data
                let data;
                try {
                    const res = await fetch(scheduleUrl);
                    data = await res.json();
                } catch (e) {
                    showError('Daten konnten nicht geladen werden. Bitte Verbindung prüfen.');
                    return;
                }

                const toMinutes = (hhmm) => parseInt(hhmm.slice(0, 2), 10) * 60 + parseInt(hhmm.slice(-2), 10);
                const toHours = (mins) => `${String(Math.floor(mins / 60) % 24).padStart(2, '0')}:${String(mins % 60).padStart(2, '0')}`;

                // Room abbreviations/icons
                const abbreviateRoom = (roomName) => {
                    if (roomName === 'One') return '1';
                    if (roomName === 'Zuse') return 'Z';
                    if (roomName === 'Fuse') return 'F';
                    if (roomName === 'Ground') return 'G';
                    if (roomName === 'Two') return '2';
                    if (roomName === 'Zero') return '0';
                    if (roomName === 'SoS Saal 6') return '6';
                    if (roomName.includes('Stonewall IO')) return 'Y';
                    if (roomName.includes('Hardware Hacking Area')) return '<i data-lucide="wrench"></i>';
                    if (roomName.includes('Bits&Bäume')) return '<i data-lucide="trees"></i>';
                    if (roomName === 'House of Tea') return '<i data-lucide="coffee"></i>';
                    if (roomName.includes('Sendezentrum')) return '<i data-lucide="mic-vocal"></i>';
                    if (roomName === 'Chaos Computer Music Club') return '<i data-lucide="music"></i>';
                    if (roomName === 'Chill Floor') return '<i data-lucide="armchair"></i>';
                    if (roomName === 'Komonin') return '<i data-lucide="door-open"></i>';
                    if (roomName.startsWith('SoS Stage ') || roomName.startsWith('SoS Lecture ') || roomName.startsWith('SoS Workshop ')) {
                        return roomName.split(' ').pop();
                    }
                    if (roomName.startsWith('Kidspace')) return '<i data-lucide="toy-brick"></i>';
                    return '*';
                };

                // Version string formatting for legend footer
                const formatVersion = (dataVersion) => {
                    let formattedVersion = dataVersion || 'unknown';
                    const dateMatch = formattedVersion.match(/(\d{4})-(\d{2})-(\d{2})[ T](\d{2}:\d{2}(?::\d{2}(?:\.\d+)?(?:Z|[+-]\d{2}:?\d{2})?)?)/);
                    const versionTokenMatch = formattedVersion.match(/Version\s+([^;\s]+)/i);
                    const fallbackToken = formattedVersion.split(/[^\w.]+/).filter(Boolean)[0] || '';
                    const versionToken = versionTokenMatch ? versionTokenMatch[1] : fallbackToken;

                    if (versionToken && dateMatch) {
                        const [, year, month, day, time] = dateMatch;
                        const timeNoTZ = time.replace(/(Z|[+-]\d{2}:?\d{2})$/, '');
                        return `v${versionToken} vom ${day}.${month}.${year} ${timeNoTZ}`;
                    }
                    if (versionToken) return `v${versionToken}`;
                    if (dateMatch) {
                        const [, year, month, day, time] = dateMatch;
                        const timeNoTZ = time.replace(/(Z|[+-]\d{2}:?\d{2})$/, '');
                        return `${day}.${month}.${year} ${timeNoTZ}`;
                    }
                    return formattedVersion;
                };

                // Render one schedule row
                const renderRow = (row, trackCodeOverride = null) => {
                    const duration = toMinutes(row.duration);
                    const speakerNames = (row.persons || []).map((p) => p.name);
                    const speaker = speakerNames.length ? speakerNames.join(', ') : '<em>no speaker found</em>';

                    let trackCode = trackCodeOverride || trackMap[row.track] || 'NAT';
                    if (row.roomName.startsWith('Kidspace')) trackCode = 'KID';

                    const recordingIcon = (row.do_not_record === false)
                        ? '<div class="no-video-icon"><i data-lucide="video"></i></div>'
                        : (row.do_not_record === true)
                            ? '<div class="no-video-icon"><i data-lucide="video-off"></i></div>'
                            : '';

                    const roomAbbrev = abbreviateRoom(row.roomName);
                    const redRoomsList = ['1', '0', 'F', 'G'];
                    const trainClass = redRoomsList.includes(roomAbbrev) ? ' train-number-red' : '';
                    const trainId = row.id.toString().substring(0, 5);
                    const longNumClass = trainId.length > 2 ? ' train-num-long' : '';
                    const roomNameDisplay = roomAbbrev.includes('*') ? ` <span class="room-name">* ${row.roomName}</span>` : '';

                    return `
            <div class="departure-row">
                <div class="time">${row.start}</div>
                <div class="trains">
                    <div class="train-number${trainClass}"><span class="train-prefix">${trackCode}</span>&#8239;<span class="train-num${longNumClass}">${trainId}</span></div>
                    ${recordingIcon}
                </div>
                <div class="route">
                    <span class="destination">${row.title}&#8239;<i data-lucide="circle-dot"></i></span>
                    <span class="station">${speaker}</span>
                    <span class="station-time">(&#8239;→&#8239;${toHours(toMinutes(row.start) + duration)}&#8239;)${roomNameDisplay}</span>
                </div>
                <div class="row-number">${roomAbbrev}</div>
            </div>`;
                };

                const getTimeRangeLabel = (time) => {
                    const mins = toMinutes(time);
                    const hour = Math.floor(mins / 60) % 24;
                    for (const r of timeRanges) {
                        if (r.start <= r.end) {
                            if (hour >= r.start && hour <= r.end) return r.label;
                        } else {
                            // wrap around midnight
                            if (hour >= r.start || hour <= r.end) return r.label;
                        }
                    }
                    return null;
                };

                // Legend HTML
                const renderLegend = (formattedVersion, footerText) => `
        <div class="time-range legend-title">
                <div style="grid-column: 2 / -1; text-align: left;">Zeichenerklärung/Explanations/Legende</div>
        </div>
        <div class="legend-section">
                <div class="legend-group">
                        <h4>Events im Hauptverkehr/Main stage events/trains grandes lignes</h4>
                        <table class="legend-table">
                                <tr><td>ART</td><td>Art & Beauty</td></tr>
                                <tr><td>CCC</td><td>CCC & Community</td></tr>
                                <tr><td>HARD</td><td>Hardware</td></tr>
                                <tr><td>ESP</td><td>Ethics, Society & Politics</td></tr>
                                <tr><td>SCI</td><td>Science</td></tr>
                                <tr><td>SEC</td><td>Security</td></tr>
                        </table>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-group">
                        <h4>Alle anderen Einträge/All other entries/Tous les autres</h4>
                        <table class="legend-table">
                                <tr><td>KID</td><td>Kidspace</td></tr>
                                <tr><td>DJ</td><td>DJ-Set</td></tr>
                                <tr><td>LP</td><td>Live Performance</td></tr>
                                <tr><td>NAT</td><td>Not a Track</td></tr>
                        </table>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-group">
                        <h4>Symbole</h4>
                        <table class="legend-table">
                                <tr><td><i data-lucide="video"></i></td><td>Diese Fahrt wird zu Schulungszwecken aufgezeichnet</td></tr>
                                <tr><td><i data-lucide="video-off"></i></td><td>Diese Fahrt ist geplant kaputt</td></tr>
                                <tr><td><i data-lucide="circle-dot"></i></td><td>bis hier sind alle Halte angegeben</td></tr>
                                <tr><td><i data-lucide="toy-brick"></i></td><td>hält nur in Kidspace</td></tr>
                                <tr><td><i data-lucide="mic-vocal"></i></td><td>hält nur in Sendezentrum</td></tr>
                                <tr><td><i data-lucide="coffee"></i></td><td>hält nur in House of Tea</td></tr>
                                <tr><td><i data-lucide="wrench"></i></td><td>hält nur in Hardware Hacking Area</td></tr>
                                <tr><td><i data-lucide="music"></i></td><td>hält nur in Chaos Computer Music Club</td></tr>
                                <tr><td><i data-lucide="armchair"></i></td><td>hält nur in Chill Floor</td></tr>
                                <tr><td><i data-lucide="door-open"></i></td><td>hält nur in Komonin</td></tr>
                                <tr><td><i data-lucide="trees"></i></td><td>hält nur in Bits&Bäume</td></tr>
                        </table>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-group">
                        <h4>Als allgemeine Feiertage gelten:</h4>
                        <div>Tag 0 bis Tag 4: 26.12. bis 30.12.</div>
                        <div>Digital Independence Day (DI.DAY)</div>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-footer">
                        Berichtigt werden nur die im CCH abgehängten Fahrpläne./Only Fahrpläne removed from display in CCH will be corrected./Seulement les Fahrpläne retirés de l'affichage dans le CCH seront corrigés.<br><br>
                        Angaben mit Gewähr - Änderungen und Irrtümer vorbehalten.<br><br>
                        * Du suchst hier leider an der falschen Stelle.<br><br>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=https://bahnhof.de" alt="QR Code" class="qr-code-placeholder">
                        Von Anton und Felix.
                        Bei Feedback und Änderungsvorschlägen siehe <a href="https://github.com/felixdivo/c3-fahrplan-druck" target="_blank">github.com/felixdivo/c3-fahrplan-druck</a>.<br><br>

                        Datenstand: ${formattedVersion}<br><br>

                        ${footerText}
                </div>
        </div>`;

                const formattedVersion = formatVersion(data.schedule.version || 'unknown');

                // Multi-day view
                if (!isSingleDay) {
                    // Multi-day rendering (original behavior)
                    const allTalks = [];
                    data.schedule.conference.days.forEach((day) => {
                        Object.entries(day.rooms).forEach(([roomName, talks]) => {
                            talks.forEach((talk) => {
                                if (!passesFilters(talk, roomName)) return;
                                allTalks.push({ ...talk, dayIndex: day.index, roomName });
                            });
                        });
                    });

                    // Sort by day, time, room; move <06:00 to end of each day
                    const timeForSort = (hhmm) => {
                        const mins = toMinutes(hhmm);
                        return mins < 360 ? mins + (24 * 60) : mins;
                    };
                    allTalks.sort((a, b) => {
                        if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                        const aTime = timeForSort(a.start);
                        const bTime = timeForSort(b.start);
                        if (aTime !== bTime) return aTime - bTime;
                        return a.roomName.localeCompare(b.roomName);
                    });

                    departureTable.innerHTML = '';
                    let currentDay = null;
                    allTalks.forEach((row) => {
                        if (currentDay !== row.dayIndex) {
                            currentDay = row.dayIndex;
                            const dayHTML = `
                        <div class="time-range">
                                <div></div>
                                <div></div>
                                <div>Day ${row.dayIndex}</div>
                                <div></div>
                        </div>`;
                            departureTable.insertAdjacentHTML('beforeend', dayHTML);
                        }

                        departureTable.insertAdjacentHTML('beforeend', renderRow(row));
                    });

                    // Legend footer text (original)
                    const legend = renderLegend(formattedVersion, `Dieses Fahplan ist bis Tag ${totalDays} (17:00) Eigentum der Chaosland Bahn. Danach geht er in die chaotische Selbstverwaltung über und darf legal entwendet werden.`);
                    departureTable.insertAdjacentHTML('beforeend', legend);
                } else {
                    // Single-day view
                    // Single-day rendering
                    const dayObj = data?.schedule?.conference?.days?.find((d) => d.index === selectedDay);
                    if (!dayObj) {
                        showError(`Keine Inhalte für Tag ${selectedDay} gefunden. Versuchen Sie z.B. ?only-day=0 oder ?only-day=2 in der URL.`);
                        return;
                    }

                    const dayTalks = [];
                    Object.entries(dayObj.rooms || {}).forEach(([roomName, talks]) => {
                        talks.forEach((talk) => {
                            if (!passesFilters(talk, roomName)) return;
                            dayTalks.push({ ...talk, dayIndex: dayObj.index, roomName });
                        });
                    });

                    if (!dayTalks.length) {
                        showError(`Keine Inhalte für Tag ${selectedDay} gefunden. Versuchen Sie z.B. ?only-day=0 oder ?only-day=2 in der URL.`);
                        return;
                    }

                    const timeForSort = (hhmm) => {
                        const mins = toMinutes(hhmm);
                        return mins < 360 ? mins + (24 * 60) : mins;
                    };
                    dayTalks.sort((a, b) => {
                        const aTime = timeForSort(a.start);
                        const bTime = timeForSort(b.start);
                        if (aTime !== bTime) return aTime - bTime;
                        return a.roomName.localeCompare(b.roomName);
                    });

                    // Update header to show day/date
                    if (headerLeft) {
                        const [year, month, day] = (dayObj.date || '').split('-');
                        headerLeft.textContent = `${day}.${month}.${year} — Tag ${selectedDay}`;
                    }

                    departureTable.innerHTML = '';
                    let currentRange = null;
                    dayTalks.forEach((row, idx) => {
                        const rangeLabel = getTimeRangeLabel(row.start);
                        if (rangeLabel && rangeLabel !== currentRange) {
                            currentRange = rangeLabel;
                            const headerHTML = `
                        <div class="time-range">
                            <div></div>
                            <div></div>
                            <div>${rangeLabel}</div>
                            <div></div>
                        </div>`;
                            departureTable.insertAdjacentHTML('beforeend', `<div class="time-range-group">${headerHTML}`);
                            departureTable.insertAdjacentHTML('beforeend', renderRow(row));
                            departureTable.insertAdjacentHTML('beforeend', '</div>');
                        } else {
                            departureTable.insertAdjacentHTML('beforeend', renderRow(row));
                        }
                    });

                    const takeWithText = selectedDay === totalDays
                        ? 'Nimm mich beim Abbau mit.'
                        : `Nimm mich ab Tag ${selectedDay + 1} mit, aber lass das Klebeband da.`;

                    const legend = renderLegend(formattedVersion, takeWithText);
                    departureTable.insertAdjacentHTML('beforeend', legend);
                }

                if (window.lucide) window.lucide.createIcons();
            })();
        </script>
</body>
</html>