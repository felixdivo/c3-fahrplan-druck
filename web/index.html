<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrplan</title>
    <meta name="author" content="Anton P. Braun and Felix Divo">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <noscript>JavaScript is required to render the schedule. Please enable it and reload.</noscript>
    <!-- Header -->
    <header class="header">
        <div>27.12.2025 – 30.12.2025</div>
        <div><b><span class="c3-logo">&lt;&lt;39C3</span></b></div>
    </header>

    <!-- Title Section -->
    <div class="title-section">
        <div class="title-label">
            <b>Abfahrt</b>
            <i>Departure</i>
            <i>Départ</i>
        </div>
        <b class="station-name">Chaos Communication Congress</b>
    </div>

    <!-- Column Headers - Repeated 8 times -->
    <div class="column-headers-wrapper">
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
        <div class="column-headers">
            <div><b>Zeit</b><br><i>Time</i></div>
            <div><b>Zug</b><br><i>Train</i></div>
            <div><b>Richtung</b><br><i>Destination</i></div>
            <div class="col-platform"><b>Gleis</b><br><i>Platform</i></div>
        </div>
    </div>

    <!-- Departure Rows -->
    <div class="departure-table"></div>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
        <script>
            (async () => {
                // Event-specific configuration
                const scheduleUrl = 'https://api.events.ccc.de/congress/2025/schedule.json';
                const trackMap = {
                    'Art & Beauty': 'ART',
                    'CCC & Community': 'CCC',
                    'Entertainment': 'FUN',
                    'Ethics, Society & Politics': 'ESP',
                    'Hardware': 'HARD',
                    'Science': 'SCI',
                    'Security': 'SEC',
                    'DJ-Set': 'DJ',
                    'Live Performance': 'LP',
                    null: 'NAT',
                    undefined: 'NAT',
                };
                const totalDays = 4;
                const headerDateRange = '27.12.2025 – 30.12.2025';
                const stationName = 'Chaos Communication Congress';
                const timeRanges = [
                    { start: 9, end: 11, label: '9.00 — 11.00' },
                    { start: 12, end: 13, label: '12.00 — 13.00' },
                    { start: 14, end: 15, label: '14.00 — 15.00' },
                    { start: 16, end: 18, label: '16.00 — 18.00' },
                    { start: 19, end: 20, label: '19.00 — 20.00' },
                    { start: 21, end: 22, label: '21.00 — 22.00' },
                    { start: 23, end: 1, label: '23.00 — 01.00' },
                    { start: 2, end: 4, label: '02.00 — 04.00' },
                    { start: 5, end: 8, label: '05.00 — 08.00' },
                ];

                // Room abbreviations/icons
                const roomAbbrevMap = {
                    'One': '1',
                    'Fuse': 'F',
                    'Ground': 'G',
                    'Zero': 'Z',
                    'SoS Saal 6': '6',
                    'House of Tea': '<i data-lucide="coffee"></i>',
                    'Chaos Computer Music Club': '<i data-lucide="music"></i>',
                    'Chill Floor': '<i data-lucide="armchair"></i>',
                    'Komonin': '<i data-lucide="door-open"></i>'
                };
                const roomAbbrevPartial = {
                    'Stonewall IO': 'Y',
                    'Hardware Hacking Area': '<i data-lucide="wrench"></i>',
                    'Bits&Bäume': '<i data-lucide="trees"></i>',
                    'Sendezentrum': '<i data-lucide="mic-vocal"></i>'
                };

                // URL parameter parsing
                const params = new URLSearchParams(location.search);
                const onlyDayParam = params.get('only-day');
                const onlyTrackParam = params.get('only-track');
                const onlyRoomParam = params.get('only-room');
                const isSingleDay = onlyDayParam !== null;
                const selectedDay = parseInt(onlyDayParam ?? '1', 10);

                // DOM hooks
                const headerLeft = document.querySelector('.header > div:first-child');
                const stationNameEl = document.querySelector('.station-name');
                const departureTable = document.querySelector('.departure-table');
                if (!departureTable) return;

                // Apply header labels
                if (headerLeft && headerDateRange) headerLeft.textContent = headerDateRange;
                if (stationNameEl && stationName) stationNameEl.textContent = stationName;

                // Build active filter label text
                const filterLabelParts = [];
                if (onlyRoomParam) filterLabelParts.push(onlyRoomParam);

                const findTrackDisplay = (trackParam) => {
                    if (!trackParam) return null;
                    const target = trackParam.toLowerCase();
                    const match = Object.entries(trackMap).find(([key, code]) => 
                        (key || '').toLowerCase() === target || (code || '').toLowerCase() === target
                    );
                    return match ? match[0] : trackParam;
                };

                const trackDisplay = findTrackDisplay(onlyTrackParam);
                if (trackDisplay) filterLabelParts.push(trackDisplay);
                if (stationNameEl && filterLabelParts.length) {
                    stationNameEl.textContent = `${stationName} — ${filterLabelParts.join(' — ')}`;
                }

                // Filter predicates with cached targets
                const trackTarget = onlyTrackParam?.toLowerCase();
                const roomTarget = onlyRoomParam?.toLowerCase();
                const passesFilters = (talk, roomName) => {
                    if (trackTarget) {
                        const trackRaw = (talk.track || '').toString().toLowerCase();
                        const trackCode = (trackMap[talk.track] || '').toLowerCase();
                        if (trackRaw !== trackTarget && trackCode !== trackTarget) return false;
                    }
                    if (roomTarget && !roomName.toLowerCase().match(new RegExp(roomTarget))) return false;
                    return true;
                };

                const showError = (msg) => {
                    departureTable.innerHTML = `<div class="no-data">${msg}</div>`;
                };
                departureTable.innerHTML = '<div class="loading">Lade Inhalte…</div>';

                // Fetch schedule data
                let data;
                try {
                    const res = await fetch(scheduleUrl);
                    data = await res.json();
                } catch (e) {
                    showError('Daten konnten nicht geladen werden. Bitte Verbindung prüfen.');
                    return;
                }

                const toMinutes = (hhmm) => parseInt(hhmm.slice(0, 2), 10) * 60 + parseInt(hhmm.slice(-2), 10);
                const toHours = (mins) => `${String(Math.floor(mins / 60) % 24).padStart(2, '0')}:${String(mins % 60).padStart(2, '0')}`;
                const timeForSort = (hhmm) => {
                    const mins = toMinutes(hhmm);
                    return mins < 360 ? mins + (24 * 60) : mins;
                };

                const abbreviateRoom = (roomName) => {
                    if (roomAbbrevMap[roomName]) return roomAbbrevMap[roomName];
                    for (const [key, val] of Object.entries(roomAbbrevPartial)) {
                        if (roomName.includes(key)) return val;
                    }
                    if (/^SoS (Stage|Lecture|Workshop) /.test(roomName)) return roomName.split(' ').pop();
                    if (roomName.startsWith('Kidspace')) return '<i data-lucide="toy-brick"></i>';
                    return '*';
                };

                // Version string formatting for legend footer
                const formatVersion = (dataVersion) => {
                    const input = dataVersion || 'unknown';
                    const dateMatch = input.match(/(\d{4})-(\d{2})-(\d{2})[ T](\d{2}:\d{2}(?::\d{2}(?:\.\d+)?(?:Z|[+-]\d{2}:?\d{2})?)?)/);
                    const versionTokenMatch = input.match(/Version\s+([^;\s]+)/i);
                    const versionToken = versionTokenMatch?.[1] || input.split(/[^\w.]+/).filter(Boolean)[0] || '';

                    if (dateMatch) {
                        const [, year, month, day, time] = dateMatch;
                        const timeNoTZ = time.replace(/(Z|[+-]\d{2}:?\d{2})$/, '');
                        const dateStr = `${day}.${month}.${year} ${timeNoTZ}`;
                        return versionToken ? `v${versionToken} vom ${dateStr}` : dateStr;
                    }
                    return versionToken ? `v${versionToken}` : input;
                };

                // Render recording icon
                const recordingIconHTML = (doNotRecord) => {
                    if (doNotRecord === false) return '<div class="no-video-icon"><i data-lucide="video"></i></div>';
                    if (doNotRecord === true) return '<div class="no-video-icon"><i data-lucide="video-off"></i></div>';
                    return '';
                };

                // Render one schedule row
                const renderRow = (row, trackCodeOverride = null) => {
                    const duration = toMinutes(row.duration);
                    const speaker = (row.persons || []).map(p => p.name).join(', ') || '<em>no speaker found</em>';
                    let trackCode = trackCodeOverride || trackMap[row.track] || 'NAT';
                    if (row.roomName.startsWith('Kidspace')) trackCode = 'KID';

                    const roomAbbrev = abbreviateRoom(row.roomName);
                    const trainId = row.id.toString().substring(0, 5);
                    const trainClass = ['1', '0', 'F', 'G'].includes(roomAbbrev) ? ' train-number-red' : '';
                    const longNumClass = trainId.length > 2 ? ' train-num-long' : '';
                    const roomNameDisplay = roomAbbrev.includes('*') ? ` <span class="room-name">* ${row.roomName}</span>` : '';

                    return `
            <div class="departure-row">
                <div class="time">${row.start}</div>
                <div class="trains">
                    <div class="train-number${trainClass}"><span class="train-prefix">${trackCode}</span>&#8239;<span class="train-num${longNumClass}">${trainId}</span></div>
                    ${recordingIconHTML(row.do_not_record)}
                </div>
                <div class="route">
                    <span class="destination"><a href="${row.url}">${row.title}</a>&#8239;<i data-lucide="circle-dot"></i></span>
                    <span class="station">${speaker}</span>
                    <span class="station-time">(&#8239;→&#8239;${toHours(toMinutes(row.start) + duration)}&#8239;)${roomNameDisplay}</span>
                </div>
                <div class="row-number">${roomAbbrev}</div>
            </div>`;
                };

                const getTimeRangeLabel = (time) => {
                    const hour = Math.floor(toMinutes(time) / 60) % 24;
                    return timeRanges.find(r => r.start <= r.end ? (hour >= r.start && hour <= r.end) : (hour >= r.start || hour <= r.end))?.label ?? null;
                };

                // Legend HTML
                const renderLegend = (formattedVersion, footerText) => `
        <div class="time-range legend-title">
                <div style="grid-column: 2 / -1; text-align: left;">Zeichenerklärung/Explanations/Legende</div>
        </div>
        <div class="legend-section">
                <div class="legend-group">
                        <h4>Events im Hauptverkehr/Main stage events/trains grandes lignes</h4>
                        <table class="legend-table">
                                <tr><td>ART</td><td>Art & Beauty</td></tr>
                                <tr><td>CCC</td><td>CCC & Community</td></tr>
                                <tr><td>HARD</td><td>Hardware</td></tr>
                                <tr><td>ESP</td><td>Ethics, Society & Politics</td></tr>
                                <tr><td>SCI</td><td>Science</td></tr>
                                <tr><td>SEC</td><td>Security</td></tr>
                        </table>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-group">
                        <h4>Alle anderen Einträge/All other entries/Tous les autres</h4>
                        <table class="legend-table">
                                <tr><td>KID</td><td>Kidspace</td></tr>
                                <tr><td>DJ</td><td>DJ-Set</td></tr>
                                <tr><td>LP</td><td>Live Performance</td></tr>
                                <tr><td>NAT</td><td>Not a Track</td></tr>
                        </table>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-group">
                        <h4>Symbole</h4>
                        <table class="legend-table">
                                <tr><td><i data-lucide="video"></i></td><td>Diese Fahrt wird zu Schulungszwecken aufgezeichnet</td></tr>
                                <tr><td><i data-lucide="video-off"></i></td><td>Diese Fahrt ist geplant kaputt</td></tr>
                                <tr><td><i data-lucide="circle-dot"></i></td><td>bis hier sind alle Halte angegeben</td></tr>
                                <tr><td><i data-lucide="toy-brick"></i></td><td>hält nur in Kidspace</td></tr>
                                <tr><td><i data-lucide="mic-vocal"></i></td><td>hält nur in Sendezentrum</td></tr>
                                <tr><td><i data-lucide="coffee"></i></td><td>hält nur in House of Tea</td></tr>
                                <tr><td><i data-lucide="wrench"></i></td><td>hält nur in Hardware Hacking Area</td></tr>
                                <tr><td><i data-lucide="music"></i></td><td>hält nur in Chaos Computer Music Club</td></tr>
                                <tr><td><i data-lucide="armchair"></i></td><td>hält nur in Chill Floor</td></tr>
                                <tr><td><i data-lucide="door-open"></i></td><td>hält nur in Komonin</td></tr>
                                <tr><td><i data-lucide="trees"></i></td><td>hält nur in Bits&Bäume</td></tr>
                        </table>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-group">
                        <h4>Als allgemeine Feiertage gelten:</h4>
                        <div>Tag 0 bis Tag 4: 26.12. bis 30.12.</div>
                        <div>Digital Independence Day (DI.DAY)</div>
                </div>

                <div style="height: 1em;"></div>

                <div class="legend-footer">
                        Berichtigt werden nur die im CCH abgehängten Fahrpläne./Only Fahrpläne removed from display in CCH will be corrected./Seulement les Fahrpläne retirés de l'affichage dans le CCH seront corrigés.<br><br>
                        Angaben mit Gewähr - Änderungen und Irrtümer vorbehalten.<br><br>
                        * Du suchst hier leider an der falschen Stelle.<br><br>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=https://bahnhof.de" alt="QR Code" class="qr-code-placeholder">
                        Von Anton und Felix.
                        Bei Feedback und Änderungsvorschlägen siehe <a href="https://github.com/felixdivo/c3-fahrplan-druck" target="_blank">github.com/felixdivo/c3-fahrplan-druck</a>.<br><br>

                        Datenstand: ${formattedVersion}<br><br>

                        ${footerText}
                </div>
        </div>`;

                const formattedVersion = formatVersion(data.schedule.version || 'unknown');
                const errorMsg = `Keine Inhalte für Tag ${selectedDay} gefunden. Versuchen Sie z.B. ?only-day=0 oder ?only-day=2 in der URL.`;

                // Helper to render header and first row in group
                const renderHeaderGroup = (label, row) => {
                    const headerHTML = `<div class="time-range"><div></div><div></div><div>${label}</div><div></div></div>`;
                    return `<div class="time-range-group">${headerHTML}${renderRow(row)}</div>`;
                };

                // Collect and sort talks from specified days
                const collectAndSortTalks = (days, includeDay = true) => {
                    const talks = [];
                    days.forEach((day) => {
                        Object.entries(day.rooms).forEach(([roomName, roomTalks]) => {
                            roomTalks.forEach((talk) => {
                                if (passesFilters(talk, roomName)) {
                                    talks.push({ ...talk, dayIndex: day.index, roomName });
                                }
                            });
                        });
                    });
                    talks.sort((a, b) => {
                        if (includeDay && a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                        const aTime = timeForSort(a.start);
                        const bTime = timeForSort(b.start);
                        if (aTime !== bTime) return aTime - bTime;
                        return a.roomName.localeCompare(b.roomName);
                    });
                    return talks;
                };

                if (!isSingleDay) {
                    // Multi-day view: render all talks grouped by day
                    const allTalks = collectAndSortTalks(data.schedule.conference.days, true);

                    departureTable.innerHTML = '';
                    let currentDay = null;
                    allTalks.forEach((row) => {
                        if (currentDay !== row.dayIndex) {
                            currentDay = row.dayIndex;
                            departureTable.insertAdjacentHTML('beforeend', renderHeaderGroup(`Day ${row.dayIndex}`, row));
                        } else {
                            departureTable.insertAdjacentHTML('beforeend', renderRow(row));
                        }
                    });

                    const legend = renderLegend(formattedVersion, `Dieses Fahplan ist bis Tag ${totalDays} (17:00) Eigentum der Chaosland Bahn. Danach geht er in die chaotische Selbstverwaltung über und darf legal entwendet werden.`);
                    departureTable.insertAdjacentHTML('beforeend', legend);
                } else {
                    // Single-day view: render talks for selected day grouped by time range
                    const dayObj = data?.schedule?.conference?.days?.find((d) => d.index === selectedDay);
                    if (!dayObj) {
                        showError(errorMsg);
                        return;
                    }

                    const dayTalks = collectAndSortTalks([dayObj], false);
                    if (!dayTalks.length) {
                        showError(errorMsg);
                        return;
                    }


                    if (headerLeft) {
                        const [year, month, day] = (dayObj.date || '').split('-');
                        headerLeft.textContent = `${day}.${month}.${year} — Tag ${selectedDay}`;
                    }

                    departureTable.innerHTML = '';
                    let currentRange = null;
                    dayTalks.forEach((row) => {
                        const rangeLabel = getTimeRangeLabel(row.start);
                        if (rangeLabel && rangeLabel !== currentRange) {
                            currentRange = rangeLabel;
                            departureTable.insertAdjacentHTML('beforeend', renderHeaderGroup(rangeLabel, row));
                        } else {
                            departureTable.insertAdjacentHTML('beforeend', renderRow(row));
                        }
                    });

                    const takeWithText = selectedDay === totalDays
                        ? 'Nimm mich beim Abbau mit.'
                        : `Nimm mich ab Tag ${selectedDay + 1} mit, aber lass das Klebeband da.`;

                    const legend = renderLegend(formattedVersion, takeWithText);
                    departureTable.insertAdjacentHTML('beforeend', legend);
                }

                if (window.lucide) window.lucide.createIcons();
            })();
        </script>
</body>
</html>